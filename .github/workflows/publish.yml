name: Publish Workflow
on:
    push:
        branches:
            - 'build/release'
            - 'build/beta'

jobs:
    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Install pnpm / 安装 pnpm
                uses: pnpm/action-setup@v3
                with:
                    version: latest

            -   name: Setup Node / 配置 Node
                uses: actions/setup-node@v4
                with:
                    node-version: 25
                    cache: 'pnpm'
                    registry-url: 'https://registry.npmjs.org'

            -   name: Install Dependencies / 安装依赖
                run: pnpm install --frozen-lockfile

            -   name: Build Project / 构建项目
                run: pnpm run build

            -   name: Setup Git User / 配置 Git 用户
                run: |
                    git config --local user.email "action@github.com"
                    git config --local user.name "GitHub Action"

            -   name: Release Final / 发布正式版
                if: github.ref == 'refs/heads/build/release'
                id: release_final
                run: |
                    npm version patch -m "chore: release %s [skip ci]"
                    echo "CURRENT_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV
                    pnpm publish --no-git-checks --access public
                    git push origin build/release --follow-tags
                env:
                    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            -   name: Release Beta / 发布测试版
                if: github.ref == 'refs/heads/build/beta'
                run: |
                    npm version prerelease --preid=beta -m "chore: release beta %s [skip ci]"
                    echo "CURRENT_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV
                    pnpm publish --no-git-checks --tag beta --access public
                    git push origin build/beta --follow-tags
                env:
                    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            -   name: Pack Project / 打包项目产物
                if: env.CURRENT_VERSION != ''
                run: |
                    pnpm pack
                    TGZ_FILE=$(ls *.tgz | head -n 1)
                    echo "TGZ_FILENAME=$TGZ_FILE" >> $GITHUB_ENV
                    echo "成功打包产物: $TGZ_FILE"

            -   name: Create GitHub Release / 创建 GitHub 发布
                uses: softprops/action-gh-release@v2
                if: env.CURRENT_VERSION != ''
                with:
                    tag_name: v${{ env.CURRENT_VERSION }}
                    name: Release v${{ env.CURRENT_VERSION }}
                    files: |
                        ${{ env.TGZ_FILENAME }}
                    generate_release_notes: true